<!DOCTYPE html>
<html lang="jp">
  <head>
    <script src="../drirectRecover.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ventus-Talk</title>
    <link rel="manifest" href="../manifest.json" />
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../menu.css" />
    <link rel="stylesheet" href="group_window.css" />
    <link rel="stylesheet" href="../log.css" />
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/ico64.ico?v=1737435085854" type="image/png">
    <link rel="shortcut icon" href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/ico64.ico?v=1737435085854" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/f180.png?v=1737434524832">

    <link
      href="https://unpkg.com/cropperjs/dist/cropper.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/cropperjs"></script>
<!--
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>
      eruda.init();
      console.log("eruda-index");
    </script>-->

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/f16.png?v=1737434521141"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="48x48"
      href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/f48.png?v=1737434517565"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="144x144"
      href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/f144.png?v=1737434514145"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/f192.png?v=1737434510763"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/f512.png?v=1737434504548"
    />
    <!-- Apple Touch Icon -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/f180.png?v=1737434524832"
    />
    <link
      rel="shortcut icon"
      href="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/ico64.ico?v=1737435085854"
      type="image/x-icon"
    />
    <!-- Android -->
    <link rel="manifest" href="path/to/manifest.json" />
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="path/to/mstile-144x144.png" />
    <meta name="msapplication-config" content="path/to/browserconfig.xml" />
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/@skyway-webrtc/sdk"></script>
    <div class="sloader"></div>
    <div id="container">
      <div id="left-panel">
        <div id="user-info">
          <img src="null" alt="Profile Picture" />
          <div id="username">ユーザー名</div>
          <div id="status">トークグループを作る</div>
          <button id="testButton">通知テストボタン</button>
        </div>
        <div id="chat-list">
          <div class="chat-item" data-chat-id="XXXXXXXXXX">
            <div class="chat-details">
              <div class="chat-group-name">トークを読み込み中です。</div>
              <div class="chat-last-message">
                時間がかかりすぎる場合別タブで開き直してください。
              </div>
            </div>
          </div>
        </div>
        <div id="menu-bar">
          <div class="menu-item" data-page="home">
            <img
              src="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/ICOHome.png?v=1737195839565"
              alt="ホームアイコン"
            />
            <div>ホーム</div>
          </div>
          <div class="menu-item" data-page="talk">
            <img
              src="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/ICOTalk.png?v=1737195832005"
              alt="トークアイコン"
            />
            <div>トーク</div>
          </div>
          <div class="menu-item" data-page="settings">
            <img
              src="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/ICOSetting.png?v=1737195842738"
              alt="設定アイコン"
            />
            <div>設定</div>
          </div>
        </div>
      </div>
      <div id="right-panel">
        <div id="progress-container"><div id="progress-bar"></div></div>
        <button id="back-button">＜</button
        ><!--モバイル用-->
        <div id="menu-bar-top">
          <span id="chat-group-name">Chat Group Name</span>
          <div id="call">Call</div>
          <button id="menu-button">≡</button>
        </div>
        <div id="chat-box">
          <img
            id="logo"
            src="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/ICO_clear.png?v=1737435556229"
            alt="ロゴ"
          />
        </div>
        　
        <!--<button id="scroll-to-bottom" style="display: none;">↓</button>-->
        <div
          id="reply-target"
          style="
            display: none;
            width: 100%;
            border-bottom: 1px solid #cccccc;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
          "
        >
          <span id="reply-content"></span>
          <button
            id="close-reply"
            style="position: absolute; right: 10px; top: 10px"
          >
            ✖
          </button>
        </div>
        <div id="tool-bar">
          <img
            id="file-upload"
            src="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/ICOfile-upload.png?v=1737278924611"
            alt="ファイル"
          />
          <input type="file" id="fileInput" style="display: none" multiple />
          <textarea
            id="chat-input"
            placeholder="Type a message..."
            required
          ></textarea>
          <button id="send-button">Send</button>
        </div>
        <div id="chat-menu" class="hidden">
          <button id="close-menu-button">＞</button>
          <ul>
            <li>プロフィール設定</li>
            <li>通知設定</li>
            <li>チャット履歴</li>
            <li>その他の設定</li>
            <li><button id="delete-chat-button">このトークを削除</button></li>
          </ul>
          <div id="chat-info"><!--info--></div>
        </div>
      </div>
    </div>
    <div id="create-group-window" class="hidden">
      <div id="window-header">
        <h2>Create Group</h2>
        <button id="close-window" class="close-button">×</button>
      </div>
      <div id="group-settings">
        <img
          src="https://cdn.glitch.global/4c6a40f6-0654-48bd-96e4-a413b8aa1ec0/IMG_0206.jpeg?v=1737970822044"
          alt="トーク画像を設定してください。"
          id="group-settings-image"
        />
        <input
          type="file"
          id="file-input"
          accept="image/*"
          style="display: none"
        />
        <div class="group-name-and-button">
          <input
            type="text"
            id="group-name-input"
            placeholder="グループ名を入力"
            required
          />
          <button id="create-group-button">作成</button>
        </div>
      </div>

      <div id="selected-friends">
        <!-- 選択した友達のuserIdが表示されるcreate group -->
      </div>
      <div id="friend-list">
        <!-- 友達一覧がここに表示されるcreate group-->
      </div>
    </div>
    <!-- モーダルウィンドウ -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <img id="modal-image" src="null" alt="トーク設定画像" />
        <button id="crop-button">適用</button>
      </div>
    </div>

    <div class="call-notification-modal-overlay" id="callNotification" style="display: none;">
      <div class="call-notification-modal">
        <button class="call-close-button" onclick="closeNotification()">
          ✖
        </button>
        <p id="caller">着信があります</p>
        <div class="slide-container">
          <div class="slide-knob">タップして応答</div>
        </div>
      </div>
    </div>
    
    <script type="module" src="./app.js"></script>
    <script src="../isLogined.js"></script>
    <script src="./decorate.js" type="module"></script>
    <script src="../menuNavigation.js"></script>
    <script type="module">
      import { compressAndEncodeImage } from "../helper.js";
      const chatInput = document.getElementById("chat-input");
      const menuBar = document.getElementById("menu-bar-top");
      const initialHeight = menuBar.offsetHeight;
      const maxHeight = initialHeight * 3;
      chatInput.style.height = `${initialHeight}px`;
      chatInput.addEventListener("input", function () {
        chatInput.style.height = "auto"; // Reset height to auto
        chatInput.style.height =
          Math.min(chatInput.scrollHeight, maxHeight) + "px";
        if (chatInput.scrollHeight > maxHeight) {
          chatInput.style.overflowY = "scroll"; // Enable scroll
        } else {
          chatInput.style.overflowY = "hidden"; // Hide scroll
        }
      });
      document.getElementById("testButton").addEventListener("click", () => {
        console.log("test");
        if ("serviceWorker" in navigator && "PushManager" in window) {
          navigator.serviceWorker.ready.then((registration) => {
            registration.showNotification("テスト通知", {
              body: "これはテスト通知です。",
              icon: "icon.png",
              badge: "badge.png",
            });
          });
        }
      });
      document
        .getElementById("group-settings-image")
        .addEventListener("click", function () {
          document.getElementById("file-input").click();
        });

      document
        .getElementById("file-input")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const imageUrl = e.target.result;
              const image = document.getElementById("modal-image");
              image.src = imageUrl;
              // モーダルを表示
              const modal = document.getElementById("modal");
              modal.style.display = "flex";
              // Cropper.jsの初期化
              image.onload = function () {
                const cropper = new Cropper(image, {
                  aspectRatio: 1,
                  viewMode: 1,
                  scalable: true,
                  zoomable: true,
                });
                document
                  .getElementById("crop-button")
                  .addEventListener("click", function () {
                    const canvas = cropper.getCroppedCanvas({
                      width: 128,
                      height: 128,
                      imageSmoothingQuality: "high",
                      imageSmoothingEnabled: true,
                    });

                    // 圧縮用の関数
                    function compressAndEncodeImage(canvas, quality = 0.5) {
                      return canvas.toDataURL("image/png", quality);
                    }

                    const resultImage = document.getElementById(
                      "group-settings-image"
                    );
                    resultImage.src = compressAndEncodeImage(canvas);
                    console.log("Base64エンコードされた画像:", resultImage.src);

                    // モーダルを閉じる
                    modal.style.display = "none";
                    cropper.destroy();
                  });
              };
              // モーダルを閉じる
              document
                .getElementsByClassName("close")[0]
                .addEventListener("click", function () {
                  modal.style.display = "none";
                  cropper.destroy();
                });
            };
            reader.readAsDataURL(file);
          }
        });
    </script>
  </body>
</html>
